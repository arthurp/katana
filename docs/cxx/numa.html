<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Katana: NUMA-Awareness</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Katana
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('numa.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">NUMA-Awareness </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#numa-intro">What is NUMA?</a></li>
<li class="level1"><a href="#numa-types">NUMA Allocation Functions in Galois</a><ul><li class="level2"><a href="#numa-malloc-local">Local</a></li>
<li class="level2"><a href="#numa-malloc-floating">Floating</a></li>
<li class="level2"><a href="#numa-malloc-blocked">Blocked</a></li>
<li class="level2"><a href="#numa-malloc-interleaved">Interleaved</a></li>
<li class="level2"><a href="#numa-malloc-specific">Specific</a></li>
</ul>
</li>
<li class="level1"><a href="#numa-large-array">NUMA and Large Arrays</a></li>
<li class="level1"><a href="#numa-galois-graphs">NUMA Allocation in Galois Graphs</a></li>
<li class="level1"><a href="#numa-best-behavior">NUMA Guidelines</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="numa-intro"></a>
What is NUMA?</h1>
<p>Non-uniform memory access (NUMA) refers to the memory system design in which the memory access time depends on the location of memory. In other words, a processor accessing a memory location that is placed locally (in its socket) takes less time. If it accesses non-local memory, it incurs higher overhead. Therefore, for the best performance on a machine with NUMA architecture, program writers must consider how memory is allocated among the sockets of the machine and allocate memory such that local memory accesses occur as much as possible.</p>
<h1><a class="anchor" id="numa-types"></a>
NUMA Allocation Functions in Galois</h1>
<p>Galois supports five kinds of NUMA allocation schemes. To illustrate them, assume that we have four threads in the system and that each thread belongs to its own socket in the following figures.</p>
<h2><a class="anchor" id="numa-malloc-local"></a>
Local</h2>
<p>The thread calling the allocate will bind the pages to its local socket.</p>
<div class="image">
<img src="numa_local.png" alt=""/>
<div class="caption">
Example of Local Allocation: Thread 2 allocated the memory, so it is bound to Thread 2</div></div>
<h2><a class="anchor" id="numa-malloc-floating"></a>
Floating</h2>
<p>The allocated memory will not be pre-faulted. In other words, the first thread to touch the memory after it's allocated will bind the page to its own socket.</p>
<div class="image">
<img src="numa_floating.png" alt=""/>
<div class="caption">
Example of Floating Allocation: A chunk is bound to the first thread that touches it</div></div>
<h2><a class="anchor" id="numa-malloc-blocked"></a>
Blocked</h2>
<p>Each thread will get an even contiguous chunk of pages from the allocated memory: thread 0 gets the first contiguous chunk, thread 1 gets the next contiguous chunk, etc.</p>
<div class="image">
<img src="numa_blocked.png" alt=""/>
<div class="caption">
Example of Blocked Allocation: Each thread gets an equal chunk</div></div>
<h2><a class="anchor" id="numa-malloc-interleaved"></a>
Interleaved</h2>
<p>Distribute pages among threads (and as a result, NUMA sockets) in a round-robin fashion: for N threads, thread 0 gets page 0, thread 1 gets page 1, ..., thread N gets page N, thread 0 gets page (N + 1)...</p>
<div class="image">
<img src="numa_interleaved.png" alt=""/>
<div class="caption">
Example of Interleaved Allocation: Each chunk gets assigned in round-robin manner</div></div>
<h2><a class="anchor" id="numa-malloc-specific"></a>
Specific</h2>
<p>Specify exactly how pages are to be distributed among threads in contiguous chunks through an array (e.g. thread 0 may get first 5 pages, then thread 1 the next 3, and so on).</p>
<div class="image">
<img src="numa_specific.png" alt=""/>
<div class="caption">
Example of Specific Allocation: Contiguous chunks assigned to each thread in user-specified manner</div></div>
<h1><a class="anchor" id="numa-large-array"></a>
NUMA and Large Arrays</h1>
<p>Currently, Galois supports NUMA-aware allocation for <a class="el" href="classkatana_1_1LargeArray.html" title="Large array of objects with proper specialization for void type and supporting various allocation and...">katana::LargeArray</a> objects. After we construct a LargeArray object, we can specify the type of NUMA allocation by calling the following appropriate function:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">void</span> allocateInterleaved(size_type n) { Allocate(n, AllocType::Interleaved); }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> allocateBlocked(size_type n) { Allocate(n, AllocType::Blocked); }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> allocateLocal(size_type n) { Allocate(n, AllocType::Local); }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">void</span> allocateFloating(size_type n) { Allocate(n, AllocType::Floating); }</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> RangeArray&gt;</div>
<div class="line">  <span class="keywordtype">void</span> allocateSpecified(size_type num, RangeArray&amp; ranges) {</div>
<div class="line">    <a class="code" href="Logging_8h.html#acb4f5b0dd598df41573616f8f1e2da3f">KATANA_LOG_DEBUG_ASSERT</a>(!data_);</div>
<div class="line"> </div>
<div class="line">    real_data_ =</div>
<div class="line">        <a class="code" href="namespacekatana.html#ae72e3908a3e1dfe17e4c7f3d2b0fd70e">largeMallocSpecified</a>(num * <span class="keyword">sizeof</span>(T), <a class="code" href="namespacekatana.html#afea83498ac35d84218d622ef40b4aa41">activeThreads</a>, ranges, <span class="keyword">sizeof</span>(T));</div>
<div class="line"> </div>
<div class="line">    size_ = num;</div>
<div class="line">    data_ = <span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(real_data_.get());</div>
<div class="line">  }</div>
<div class="ttc" id="aLogging_8h_html_acb4f5b0dd598df41573616f8f1e2da3f"><div class="ttname"><a href="Logging_8h.html#acb4f5b0dd598df41573616f8f1e2da3f">KATANA_LOG_DEBUG_ASSERT</a></div><div class="ttdeci">#define KATANA_LOG_DEBUG_ASSERT(cond)</div><div class="ttdef"><b>Definition:</b> Logging.h:150</div></div>
<div class="ttc" id="anamespacekatana_html_ae72e3908a3e1dfe17e4c7f3d2b0fd70e"><div class="ttname"><a href="namespacekatana.html#ae72e3908a3e1dfe17e4c7f3d2b0fd70e">katana::largeMallocSpecified</a></div><div class="ttdeci">KATANA_EXPORT LAptr largeMallocSpecified(size_t bytes, uint32_t numThreads, RangeArrayTy &amp;threadRanges, size_t elementSize)</div><div class="ttdoc">Allocates pages for some specified number of bytes, then does NUMA page faulting based on a specified...</div><div class="ttdef"><b>Definition:</b> NumaMem.cpp:225</div></div>
<div class="ttc" id="anamespacekatana_html_afea83498ac35d84218d622ef40b4aa41"><div class="ttname"><a href="namespacekatana.html#afea83498ac35d84218d622ef40b4aa41">katana::activeThreads</a></div><div class="ttdeci">unsigned activeThreads</div><div class="ttdef"><b>Definition:</b> Chunk.h:32</div></div>
</div><!-- fragment --><p> More details can be found in <a class="el" href="LargeArray_8h.html">LargeArray.h</a>.</p>
<p>Here is an example of blocked allocation of LargeArrays for storing the data of nodes and edges in a graph.</p>
<div class="fragment"><div class="line">      nodeData.allocateBlocked(numNodes);</div>
<div class="line">      edgeIndData.allocateBlocked(numNodes);</div>
<div class="line">      edgeDst.allocateBlocked(numEdges);</div>
<div class="line">      edgeData.allocateBlocked(numEdges);</div>
</div><!-- fragment --><h1><a class="anchor" id="numa-galois-graphs"></a>
NUMA Allocation in Galois Graphs</h1>
<p>Galois also supports NUMA-aware allocation for graph data structures. Graph data structures have a template parameter called UseNumaAlloc. If it is set to true, then the graph will use Blocked NUMA allocation (<a class="el" href="classkatana_1_1LC__Linear__Graph.html" title="Local computation graph (i.e., graph structure does not change).">katana::LC_Linear_Graph</a> and <a class="el" href="classkatana_1_1LC__Morph__Graph.html" title="Local computation graph that allows addition of nodes (but not removals) if the maximum degree of a n...">katana::LC_Morph_Graph</a> will use Local allocation if UseNumaAlloc is true). Otherwise, it will use Interleaved NUMA allocation.</p>
<p>The following code snippet shows the template argument for LC_CSR_Graph from <a class="el" href="LC__CSR__Graph_8h.html">LC_CSR_Graph.h</a>:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;</div>
<div class="line">    <span class="keyword">typename</span> NodeTy, <span class="keyword">typename</span> EdgeTy, <span class="keywordtype">bool</span> HasNoLockable = <span class="keyword">false</span>,</div>
<div class="line">    <span class="keywordtype">bool</span> UseNumaAlloc = <span class="keyword">false</span>, <span class="keywordtype">bool</span> HasOutOfLineLockable = <span class="keyword">false</span>,</div>
<div class="line">    <span class="keyword">typename</span> FileEdgeTy = EdgeTy&gt;</div>
<div class="line"><span class="keyword">class </span>LC_CSR_Graph :</div>
</div><!-- fragment --><p> The NUMA allocation can also be specified using the following pattern (taken from <a class="el" href="sssp_8cpp.html">sssp.cpp</a>) without using the template parameter UseNumaAlloc.</p>
<div class="fragment"></div><!-- fragment --><p> Note that if the numaMap parameter in <a class="el" href="classkatana_1_1FileGraph.html#a0b04d18f5088336f820af34bd503f03a" title="Loads/mmaps particular portions of a graph corresponding to a node range and edge range into memory.">katana::FileGraph::partFromFile</a> is true, then Interleaved NUMA allocation is used.</p>
<h1><a class="anchor" id="numa-best-behavior"></a>
NUMA Guidelines</h1>
<p>The best NUMA scheme for a program depends on the pattern of accesses by the threads in the program.</p>
<p>For instance, if each thread accesses only a relatively even portion of memory and does not access other threads' data, then the Blocked allocation scheme will likely perform the best. On the other hand, if each thread may potentially access any part of the allocated memory, the Interleaved allocation scheme may perform best. If a thread that allocates memory will be the only thread to use it, then Local allocation can be used. Floating allocation can be used if the first thread that uses a chunk of memory will be the main user of the chunk. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="Manual.html">Manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
